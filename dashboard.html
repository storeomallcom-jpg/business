<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DS // ADMIN PANEL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700&family=Syne:wght@400;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #040810; --bg2: #080f1e;
      --card: rgba(12, 22, 45, 0.85);
      --border: rgba(0, 195, 255, 0.12); --border2: rgba(0, 195, 255, 0.25);
      --cyan: #00c3ff; --green: #00ff88; --red: #ff4466; --orange: #ff9a3c;
      --txt: #e2eaf5; --muted: #5a7299;
      --mono: 'Space Mono', monospace; --sans: 'Syne', sans-serif;
    }
    html { scroll-behavior: smooth; }
    body { font-family: var(--sans); background: var(--bg); color: var(--txt); min-height: 100vh; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 2px; }

    .grid-bg {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image:
        linear-gradient(rgba(0,195,255,0.025) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,195,255,0.025) 1px, transparent 1px);
      background-size: 60px 60px;
    }

    /* ── SCREENS ── */
    .screen { position: relative; z-index: 10; }
    .screen-hidden { display: none !important; }

    /* ── AUTH ── */
    #login-screen {
      min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px;
    }
    .login-card {
      width: 100%; max-width: 400px; border-radius: 20px; padding: 48px 40px;
      background: var(--card); backdrop-filter: blur(16px); border: 1px solid var(--border2);
    }
    .login-logo {
      font-family: var(--mono); font-size: 1rem; font-weight: 700; color: var(--red);
      letter-spacing: 0.1em; text-align: center; margin-bottom: 8px;
    }
    .login-subtitle {
      font-family: var(--mono); font-size: 0.7rem; color: var(--muted);
      text-align: center; margin-bottom: 32px; line-height: 1.6;
    }
    .form-group { margin-bottom: 16px; }
    .form-input {
      width: 100%; padding: 15px 18px;
      background: rgba(0,0,0,0.5); border: 1px solid var(--border);
      border-radius: 10px; color: var(--txt); font-family: var(--mono); font-size: 0.82rem;
      outline: none; transition: border-color 0.2s;
    }
    .form-input:focus { border-color: var(--red); box-shadow: 0 0 0 3px rgba(255,68,102,0.08); }
    .form-input::placeholder { color: var(--muted); }
    .btn-login {
      width: 100%; padding: 14px; border-radius: 10px; border: none; cursor: pointer;
      background: var(--red); color: #fff; font-family: var(--mono); font-weight: 700;
      font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; transition: all 0.2s;
    }
    .btn-login:hover { background: #ff6680; box-shadow: 0 8px 24px rgba(255,68,102,0.3); }
    .error-msg {
      font-family: var(--mono); font-size: 0.75rem; color: var(--red);
      text-align: center; margin-top: 14px; display: none;
    }
    .error-msg.visible { display: block; }

    /* ── ADMIN DASHBOARD ── */
    #admin-screen { min-height: 100vh; padding-top: 72px; }

    header.admin-header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      background: rgba(4,8,16,0.95); backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,68,102,0.2);
      padding: 14px 24px; display: flex; align-items: center; justify-content: space-between;
    }
    .admin-logo { font-family: var(--mono); font-size: 0.95rem; font-weight: 700; color: var(--red); letter-spacing: 0.1em; }
    .admin-logo span { color: var(--txt); }
    .admin-user { font-family: var(--mono); font-size: 0.7rem; color: var(--muted); }
    .btn-logout {
      background: rgba(255,68,102,0.1); border: 1px solid rgba(255,68,102,0.3);
      color: var(--red); border-radius: 8px; padding: 8px 14px; cursor: pointer;
      font-family: var(--mono); font-size: 0.72rem; transition: all 0.2s;
    }
    .btn-logout:hover { background: rgba(255,68,102,0.2); }

    .admin-main { max-width: 1200px; margin: 0 auto; padding: 28px 24px; }

    /* ── STAT CARDS ── */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 14px;
      padding: 24px 28px; backdrop-filter: blur(12px);
    }
    .stat-label { font-family: var(--mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 8px; }
    .stat-val { font-family: var(--mono); font-size: 2rem; font-weight: 700; }
    .stat-val.cyan { color: var(--cyan); }
    .stat-val.green { color: var(--green); }
    .stat-val.orange { color: var(--orange); }
    .stat-val.red { color: var(--red); }

    /* ── SECTION TITLE ── */
    .section-title {
      font-size: 1.1rem; font-weight: 800; margin-bottom: 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .section-title .badge {
      font-family: var(--mono); font-size: 0.65rem; background: rgba(0,195,255,0.1);
      border: 1px solid var(--border2); color: var(--cyan);
      padding: 3px 10px; border-radius: 20px; letter-spacing: 0.1em;
    }

    /* ── SEARCH / FILTER ── */
    .table-controls {
      display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
    }
    .search-input {
      flex: 1; min-width: 200px; padding: 10px 16px;
      background: rgba(0,0,0,0.4); border: 1px solid var(--border);
      border-radius: 8px; color: var(--txt); font-family: var(--mono); font-size: 0.8rem; outline: none;
    }
    .search-input:focus { border-color: var(--cyan); }
    .search-input::placeholder { color: var(--muted); }
    .btn-refresh {
      background: rgba(0,195,255,0.08); border: 1px solid var(--border2);
      color: var(--cyan); border-radius: 8px; padding: 10px 16px; cursor: pointer;
      font-family: var(--mono); font-size: 0.75rem; transition: all 0.2s; white-space: nowrap;
    }
    .btn-refresh:hover { background: rgba(0,195,255,0.16); }

    /* ── TABLE ── */
    .table-wrap {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden; backdrop-filter: blur(12px);
      margin-bottom: 32px;
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: rgba(0,195,255,0.06); color: var(--cyan);
      font-family: var(--mono); font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase;
      padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(0,195,255,0.03); }
    tbody td {
      padding: 14px 16px; font-family: var(--mono); font-size: 0.78rem; color: var(--muted);
      vertical-align: middle;
    }
    tbody td.email { color: var(--txt); max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    tbody td.balance { color: var(--green); font-weight: 700; }
    tbody td.date { font-size: 0.7rem; }

    /* ── INLINE BALANCE EDIT ── */
    .balance-edit-row { display: flex; gap: 6px; align-items: center; }
    .balance-input {
      width: 80px; padding: 6px 10px;
      background: rgba(0,0,0,0.5); border: 1px solid var(--border);
      border-radius: 6px; color: var(--txt); font-family: var(--mono); font-size: 0.75rem; outline: none;
    }
    .balance-input:focus { border-color: var(--cyan); }
    .btn-adjust {
      padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer;
      font-family: var(--mono); font-size: 0.68rem; font-weight: 700; transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-add { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
    .btn-add:hover { background: rgba(0,255,136,0.25); }
    .btn-sub { background: rgba(255,68,102,0.12); color: var(--red); border: 1px solid rgba(255,68,102,0.3); }
    .btn-sub:hover { background: rgba(255,68,102,0.22); }

    /* ── TRANSACTIONS TABLE ── */
    .tx-type {
      display: inline-block; padding: 2px 8px; border-radius: 4px;
      font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase;
    }
    .tx-debit        { background: rgba(255,68,102,0.1); color: var(--red); }
    .tx-topup        { background: rgba(0,255,136,0.1); color: var(--green); }
    .tx-bonus        { background: rgba(0,195,255,0.1); color: var(--cyan); }
    .tx-referral     { background: rgba(255,154,60,0.1); color: var(--orange); }
    .tx-admin        { background: rgba(90,114,153,0.2); color: var(--muted); }

    /* ── EMPTY / LOADING ── */
    .table-loading, .table-empty {
      padding: 48px; text-align: center; font-family: var(--mono);
      font-size: 0.82rem; color: var(--muted);
    }
    .spinner-sm {
      display: inline-block; width: 20px; height: 20px;
      border: 2px solid rgba(0,195,255,0.2); border-top-color: var(--cyan);
      border-radius: 50%; animation: spin 0.9s linear infinite; vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── TOAST ── */
    #toast-container { position: fixed; top: 80px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: var(--card); border: 1px solid var(--border2); border-radius: 10px;
      padding: 12px 16px; font-family: var(--mono); font-size: 0.75rem; max-width: 280px;
      animation: toastIn 0.3s ease-out;
    }
    .toast.success { border-color: rgba(0,255,136,0.3); color: var(--green); }
    .toast.error   { border-color: rgba(255,68,102,0.3); color: var(--red); }
    .toast.info    { color: var(--cyan); }
    @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    /* ── PAGINATION ── */
    .pagination { display: flex; gap: 8px; justify-content: center; margin-top: 16px; flex-wrap: wrap; }
    .page-btn {
      padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--muted); font-family: var(--mono); font-size: 0.72rem;
      cursor: pointer; transition: all 0.2s;
    }
    .page-btn.active { background: rgba(0,195,255,0.12); border-color: var(--border2); color: var(--cyan); }
    .page-btn:hover:not(.active) { border-color: var(--border2); color: var(--txt); }

    @media (max-width: 768px) {
      thead th:nth-child(4), tbody td:nth-child(4) { display: none; }
      .balance-input { width: 60px; }
      .admin-user { display: none; }
    }
  </style>
</head>
<body>

<div class="grid-bg"></div>
<div id="toast-container"></div>

<!-- ======= LOGIN ======= -->
<div id="login-screen" class="screen">
  <div class="login-card">
    <div class="login-logo">⚠ DS // <span>ADMIN</span></div>
    <p class="login-subtitle">Restricted access.<br>Authorized personnel only.</p>

    <div class="form-group">
      <input type="email" id="login-email" class="form-input" placeholder="Admin email" />
    </div>
    <div class="form-group">
      <input type="password" id="login-password" class="form-input" placeholder="Password" />
    </div>
    <button class="btn-login" onclick="adminLogin()"><i class="fas fa-lock"></i> Access Admin Panel</button>
    <p class="error-msg" id="login-error">Access denied. Admin account only.</p>
  </div>
</div>

<!-- ======= ADMIN DASHBOARD ======= -->
<div id="admin-screen" class="screen screen-hidden">
  <header class="admin-header">
    <span class="admin-logo">⚡ DS // <span>ADMIN PANEL</span></span>
    <span class="admin-user" id="admin-email-display">—</span>
    <button class="btn-logout" onclick="adminLogout()"><i class="fas fa-power-off"></i> Logout</button>
  </header>

  <main class="admin-main">

    <!-- STATS -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <p class="stat-label">Total Users</p>
        <p class="stat-val cyan" id="stat-users">—</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Total Credits Issued</p>
        <p class="stat-val green" id="stat-credits">—</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Total READMEs Generated</p>
        <p class="stat-val orange" id="stat-readmes">—</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Revenue (USDT Topups)</p>
        <p class="stat-val red" id="stat-revenue">—</p>
      </div>
    </div>

    <!-- USERS TABLE -->
    <div class="section-title">
      All Users <span class="badge" id="user-count-badge">0</span>
    </div>

    <div class="table-controls">
      <input type="text" id="user-search" class="search-input" placeholder="Search by email..." oninput="filterUsers()" />
      <button class="btn-refresh" onclick="loadUsers()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <div class="table-wrap">
      <table id="users-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Balance</th>
            <th>Signed Up</th>
            <th>Affiliate ID</th>
            <th>Adjust Balance</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="5" class="table-loading"><span class="spinner-sm"></span> Loading users...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- TRANSACTIONS TABLE -->
    <div class="section-title" style="margin-top:8px">
      Recent Transactions <span class="badge" id="tx-count-badge">0</span>
    </div>

    <div class="table-controls">
      <input type="text" id="tx-search" class="search-input" placeholder="Search transactions..." oninput="filterTx()" />
      <button class="btn-refresh" onclick="loadTransactions()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <div class="table-wrap">
      <table id="tx-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>User</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="tx-tbody">
          <tr><td colspan="5" class="table-loading"><span class="spinner-sm"></span> Loading transactions...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function () {
  var ADMIN_EMAIL = "ahmadzaoujal2009@gmail.com";
  var CFG = {
    sbUrl: "https://kutmygkodxtfbtdtwqef.supabase.co",
    sbKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1dG15Z2tvZHh0ZmJ0ZHR3cWVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTY4MzQsImV4cCI6MjA4Njg3MjgzNH0.LDd6RFbjSjF6QYqi__f7zK1oI8Ze7sa1Vv-1t2TLtkE",
  };

  var db = null;
  var allUsers = [];
  var allTx    = [];

  // ── BOOT ──────────────────────────────────────────────────
  document.addEventListener("DOMContentLoaded", function () {
    db = window.supabase.createClient(CFG.sbUrl, CFG.sbKey);

    db.auth.getSession().then(function (res) {
      var session = res && res.data && res.data.session;
      if (session && session.user && session.user.email === ADMIN_EMAIL) {
        showAdminPanel(session.user.email);
      } else if (session && session.user) {
        // Logged in but not admin — sign them out
        db.auth.signOut().then(function () { showScreen("login"); });
        showError("This account does not have admin access.");
      } else {
        showScreen("login");
      }
    });
  });

  // ── AUTH ──────────────────────────────────────────────────
  window.adminLogin = function () {
    var em = document.getElementById("login-email").value.trim();
    var pw = document.getElementById("login-password").value;

    if (!em || !pw) return showError("Email and password required.");

    if (em !== ADMIN_EMAIL) return showError("Access denied. Admin account only.");

    db.auth.signInWithPassword({ email: em, password: pw })
      .then(function (r) {
        if (r.error) throw r.error;
        if (r.data.user.email !== ADMIN_EMAIL) {
          db.auth.signOut();
          throw new Error("Not authorized.");
        }
        showAdminPanel(r.data.user.email);
      })
      .catch(function (e) { showError(e.message || "Login failed."); });
  };

  window.adminLogout = function () {
    db.auth.signOut().then(function () { showScreen("login"); });
  };

  function showAdminPanel(email) {
    showScreen("admin");
    var el = document.getElementById("admin-email-display");
    if (el) el.textContent = email;
    loadUsers();
    loadTransactions();
    loadStats();
  }

  // ── LOAD USERS ────────────────────────────────────────────
  window.loadUsers = function () {
    var tbody = document.getElementById("users-tbody");
    tbody.innerHTML = '<tr><td colspan="5" class="table-loading"><span class="spinner-sm"></span> Loading...</td></tr>';

    db.from("profiles")
      .select("id, email, credits, affiliate_id, created_at")
      .order("created_at", { ascending: false })
      .then(function (r) {
        if (r.error) throw r.error;
        allUsers = r.data || [];
        var badge = document.getElementById("user-count-badge");
        if (badge) badge.textContent = allUsers.length;
        renderUsers(allUsers);
      })
      .catch(function (e) {
        tbody.innerHTML = '<tr><td colspan="5" class="table-empty" style="color:var(--red)">Error: ' + esc(e.message) + '</td></tr>';
      });
  };

  window.filterUsers = function () {
    var q = (document.getElementById("user-search").value || "").toLowerCase();
    var filtered = q ? allUsers.filter(function (u) { return u.email && u.email.toLowerCase().includes(q); }) : allUsers;
    renderUsers(filtered);
  };

  function renderUsers(users) {
    var tbody = document.getElementById("users-tbody");
    if (!users.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="table-empty">No users found.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(function (u) {
      var date  = u.created_at ? new Date(u.created_at).toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" }) : "—";
      var affId = u.affiliate_id ? u.affiliate_id.slice(0,8) + "..." : "—";
      return [
        '<tr>',
        '  <td class="email" title="' + esc(u.email) + '">' + esc(u.email) + '</td>',
        '  <td class="balance" id="bal-' + u.id + '">$' + Number(u.credits).toFixed(2) + '</td>',
        '  <td class="date">' + date + '</td>',
        '  <td style="font-family:var(--mono);font-size:0.68rem;color:var(--muted)" title="' + esc(u.affiliate_id||'') + '">' + affId + '</td>',
        '  <td>',
        '    <div class="balance-edit-row">',
        '      <input type="number" step="0.01" class="balance-input" id="adj-' + u.id + '" placeholder="$0.00" />',
        '      <button class="btn-adjust btn-add" onclick="adjustBalance(\'' + u.id + '\', 1)"><i class="fas fa-plus"></i> Add</button>',
        '      <button class="btn-adjust btn-sub" onclick="adjustBalance(\'' + u.id + '\', -1)"><i class="fas fa-minus"></i> Sub</button>',
        '    </div>',
        '  </td>',
        '</tr>'
      ].join('');
    }).join('');
  }

  // ── ADJUST BALANCE ────────────────────────────────────────
  window.adjustBalance = function (userId, sign) {
    var inp = document.getElementById("adj-" + userId);
    var raw = parseFloat(inp ? inp.value : "");
    if (isNaN(raw) || raw <= 0) return showToast("Enter a valid positive amount.", "error");

    var amount = sign * Math.abs(raw);
    var note   = (sign > 0 ? "Admin credit: +" : "Admin debit: ") + "$" + Math.abs(amount).toFixed(2);

    db.rpc("admin_adjust_balance", {
      p_user_id: userId,
      p_amount:  amount,
      p_note:    note,
    }).then(function (r) {
      if (r.error) throw new Error(r.error.message);
      var newBal = r.data;
      var cell = document.getElementById("bal-" + userId);
      if (cell) cell.textContent = "$" + Number(newBal).toFixed(2);
      if (inp) inp.value = "";
      showToast((sign > 0 ? "Added" : "Deducted") + " $" + Math.abs(amount).toFixed(2) + " successfully.", "success");
      loadStats(); // refresh stats
    }).catch(function (e) { showToast("Error: " + e.message, "error"); });
  };

  // ── LOAD TRANSACTIONS ─────────────────────────────────────
  window.loadTransactions = function () {
    var tbody = document.getElementById("tx-tbody");
    tbody.innerHTML = '<tr><td colspan="5" class="table-loading"><span class="spinner-sm"></span> Loading...</td></tr>';

    db.from("transactions")
      .select("id, user_id, type, amount, description, tx_hash, created_at, profiles(email)")
      .order("created_at", { ascending: false })
      .limit(200)
      .then(function (r) {
        if (r.error) throw r.error;
        allTx = r.data || [];
        var badge = document.getElementById("tx-count-badge");
        if (badge) badge.textContent = allTx.length;
        renderTx(allTx);
      })
      .catch(function (e) {
        tbody.innerHTML = '<tr><td colspan="5" class="table-empty" style="color:var(--red)">Error: ' + esc(e.message) + '</td></tr>';
      });
  };

  window.filterTx = function () {
    var q = (document.getElementById("tx-search").value || "").toLowerCase();
    var filtered = q ? allTx.filter(function (t) {
      var em = (t.profiles && t.profiles.email) || "";
      var desc = t.description || "";
      return em.toLowerCase().includes(q) || desc.toLowerCase().includes(q) || (t.type||"").includes(q);
    }) : allTx;
    renderTx(filtered);
  };

  function renderTx(txs) {
    var tbody = document.getElementById("tx-tbody");
    if (!txs.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="table-empty">No transactions found.</td></tr>';
      return;
    }
    tbody.innerHTML = txs.map(function (t) {
      var date  = t.created_at ? new Date(t.created_at).toLocaleString("en-GB", { day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit" }) : "—";
      var em    = (t.profiles && t.profiles.email) ? esc(t.profiles.email) : '<span style="color:var(--muted)">—</span>';
      var typeClass = {
        "debit":          "tx-debit",
        "topup":          "tx-topup",
        "bonus":          "tx-bonus",
        "referral_bonus": "tx-referral",
        "admin_adjustment":"tx-admin",
      }[t.type] || "";
      var sign  = (t.type === "debit") ? "-" : "+";
      var color = (t.type === "debit") ? "var(--red)" : "var(--green)";
      return [
        '<tr>',
        '  <td class="date">' + date + '</td>',
        '  <td style="font-size:0.72rem">' + em + '</td>',
        '  <td><span class="tx-type ' + typeClass + '">' + esc(t.type || "") + '</span></td>',
        '  <td style="font-family:var(--mono);font-weight:700;color:' + color + '">' + sign + '$' + Number(t.amount).toFixed(2) + '</td>',
        '  <td style="font-size:0.72rem;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + esc(t.description||"") + '">' + esc(t.description || "—") + '</td>',
        '</tr>'
      ].join('');
    }).join('');
  }

  // ── LOAD STATS ────────────────────────────────────────────
  function loadStats() {
    // Total users
    db.from("profiles").select("id", { count: "exact", head: true })
      .then(function (r) {
        var el = document.getElementById("stat-users");
        if (el) el.textContent = r.count || 0;
      });

    // Credits in system (sum of all profile balances)
    db.from("profiles").select("credits")
      .then(function (r) {
        var total = (r.data || []).reduce(function (sum, p) { return sum + Number(p.credits); }, 0);
        var el = document.getElementById("stat-credits");
        if (el) el.textContent = "$" + total.toFixed(2);
      });

    // Total READMEs (debit transactions)
    db.from("transactions").select("id", { count: "exact", head: true }).eq("type", "debit")
      .then(function (r) {
        var el = document.getElementById("stat-readmes");
        if (el) el.textContent = r.count || 0;
      });

    // Revenue (topup transactions sum)
    db.from("transactions").select("amount").eq("type", "topup")
      .then(function (r) {
        var total = (r.data || []).reduce(function (sum, t) { return sum + Number(t.amount); }, 0);
        var el = document.getElementById("stat-revenue");
        // topup amount is credits, not USDT: credits/10 * 5 = USDT received
        var usdt = (total / 10) * 5;
        if (el) el.textContent = "$" + usdt.toFixed(2);
      });
  }

  // ── UI HELPERS ────────────────────────────────────────────
  function showScreen(name) {
    var map = { login: "login-screen", admin: "admin-screen" };
    Object.values(map).forEach(function (id) {
      var el = document.getElementById(id);
      if (el) el.classList.add("screen-hidden");
    });
    var target = document.getElementById(map[name]);
    if (target) target.classList.remove("screen-hidden");
  }

  function showError(msg) {
    var el = document.getElementById("login-error");
    if (el) { el.textContent = msg; el.classList.add("visible"); }
  }

  function esc(s) {
    return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function showToast(msg, type) {
    var c = document.getElementById("toast-container");
    if (!c) return;
    var t = document.createElement("div");
    t.className   = "toast " + (type || "info");
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(function () {
      t.style.cssText += "transition:opacity .4s;opacity:0";
      setTimeout(function () { t.parentNode && t.parentNode.removeChild(t); }, 400);
    }, 3500);
  }

}());
</script>
</body>
</html>
